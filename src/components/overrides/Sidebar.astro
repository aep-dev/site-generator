---
import type { Props } from "@astrojs/starlight/props";
import Default from "@astrojs/starlight/components/Sidebar.astro";
import * as fs from "fs";
import { assembleSidebarsByEdition } from "../../utils/sidebar-from-site-structure";
import type { SiteStructure } from "../../utils/site-structure";

// Load site structure and build edition-specific sidebars
const siteStructure: SiteStructure = JSON.parse(
  fs.readFileSync("generated/site-structure.json", "utf-8"),
);
const sidebarsByEdition = assembleSidebarsByEdition(siteStructure);

// Get edition from middleware (fallback) or determine from topic
const middlewareEdition = Astro.locals.edition || "general";

// Get the current topic from starlightSidebarTopics route data
const topicsData = Astro.locals.starlightSidebarTopics;
const currentTopic = topicsData?.topics?.find((t: any) => t.isCurrent);

// Map topic to edition name
// If on "aeps" topic (non-default edition), use the edition from URL
// Otherwise use "general" (default edition)
let edition = middlewareEdition;
if (currentTopic && currentTopic.label && currentTopic.label.includes("2026")) {
  edition = "aep-2026";
}

// Get the sidebar for this edition
const editionSidebar = sidebarsByEdition[edition] || sidebarsByEdition["general"] || [];

// Override the sidebar prop with edition-specific sidebar
const customProps: Props = {
  ...Astro.props,
  sidebar: editionSidebar,
};
---

<Default {...customProps} />
