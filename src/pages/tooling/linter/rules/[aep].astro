---
/**
 * Dynamic route for Protobuf Linter rule pages
 * Replaces the consolidated markdown files previously generated by the script
 */

import StarlightPage from "@astrojs/starlight/components/StarlightPage.astro";
import LinterRules from "../../../../components/LinterRules.astro";
import * as fs from "fs";
import * as path from "path";

export async function getStaticPaths() {
  // Read the linter rules JSON data
  const linterRulesPath = path.join(
    process.cwd(),
    "generated/linter-rules/protobuf.json",
  );

  // Check if the file exists
  if (!fs.existsSync(linterRulesPath)) {
    console.warn("⚠️  Protobuf linter rules JSON not found, skipping...");
    return [];
  }

  const allRules = JSON.parse(fs.readFileSync(linterRulesPath, "utf-8"));

  // Group rules by AEP number
  const rulesByAep = allRules.reduce((acc, rule) => {
    if (!acc[rule.aep]) {
      acc[rule.aep] = [];
    }
    acc[rule.aep].push(rule);
    return acc;
  }, {});

  // Generate paths for each AEP
  return Object.keys(rulesByAep).map((aep) => ({
    params: { aep },
    props: {
      rules: rulesByAep[aep],
      aep,
    },
  }));
}

const { rules, aep } = Astro.props;

// Extract preamble from first rule if available
const preamble = rules[0]?.preamble || "";
---

<StarlightPage
  frontmatter={{
    title: `AEP-${aep} Linter Rules`,
    tableOfContents: { minHeadingLevel: 1 },
  }}
  headings={[]}
>
  <LinterRules rules={rules} preamble={preamble} />
</StarlightPage>
